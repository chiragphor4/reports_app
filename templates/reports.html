{% extends 'base.html' %}
{% load static %}

{% block titleblock %} | Reports {% endblock %}

{% block tabcontentblock %}



    <div class="tab_container" style="padding:15px;overflow: auto;" id="tab_content">
        <fieldset style="    padding: 20px;
        border-color: aliceblue;" id="response_header">
            <legend style="color: #bf0711;font-weight: bold;">RESPONSE HEADERS</legend>
            <form id="reports_form" method="post">
                {% csrf_token %}
                {% include 'selectors/dimension.html' %}
                {% include 'selectors/report_type.html' %}
                {% include 'selectors/frequency.html' %}

            </form>


            <button type="submit" class="basic-save-btn" id="render_table" name="go_button" form="reports_form">GO
            </button>


        </fieldset>

    </div>
    {% include 'utilities/table/loader.html' %}

    <input type="checkbox" id="partial_select_await" hidden>

    <div id="table_div"></div>

    <script>
        function start_loading() {
            document.getElementById('table_div').style.display = 'none'
            document.getElementById('loader').style.display = 'block'
        }

        function stop_loading() {
            document.getElementById('loader').style.display = 'none'
            document.getElementById('table_div').style.display = 'block'
        }

        var csrf_token = '{{ csrf_token }}'
        $("#reports_form").on("submit", function (e) {
            let class_name_map = new Map();
            let selected_field = [];
            let fd = new FormData();
            $('#checkboxes input:checked').each(function () {
                if ($(this).attr('id').includes('--')) {
                    let checkbox_name = $(this).attr('id').split('--')[3];
                    let local_class_name = $(this).attr('class');
                    if (local_class_name != null) {
                        if (!class_name_map[local_class_name]) {
                            class_name_map[local_class_name] = [checkbox_name];
                        } else {
                            selected_field = class_name_map[local_class_name];
                            if (!selected_field.includes(checkbox_name)) {
                                selected_field.push(checkbox_name);
                            }
                        }
                    }
                }
            });
            start_loading()
            let modalDiv = $("#table_div");
            fd.append('csrfmiddlewaretoken', csrf_token)
            fd.append('report type', document.getElementById('type_code').value)
            fd.append('frequency', document.getElementById('freq_code').value)
            fd.append('dimensions', JSON.stringify(class_name_map))
            $.ajax({
                url: '/reports/',
                method: 'POST',
                data: fd,
                dataType: 'text',
                contentType: false,
                processData: false,
                success: function (data) {
                    if (data) {

                        modalDiv.html(data);
                        stop_loading()
                    } else {
                        alert("ajax call not success.");
                    }
                },
                fail: function () {
                    alert('request failed');
                }
            });
            e.preventDefault();
        });
    </script>
    <script src="{% static 'js/reports.js' %}"></script>
{% endblock %}